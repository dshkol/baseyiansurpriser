<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Bayesian Surprise with Canadian Census Data (cancensus)</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Bayesian Surprise with Canadian Census Data
(cancensus)</h1>


<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a>
<ul>
<li><a href="#paper-matching-vs.-normalized-mode" id="toc-paper-matching-vs.-normalized-mode">Paper-Matching
vs. Normalized Mode</a></li>
<li><a href="#prerequisites" id="toc-prerequisites">Prerequisites</a></li>
</ul></li>
<li><a href="#understanding-cancensus-data-structure" id="toc-understanding-cancensus-data-structure">Understanding cancensus
Data Structure</a></li>
<li><a href="#example-1-low-income-rates-by-census-division" id="toc-example-1-low-income-rates-by-census-division">Example 1: Low
Income Rates by Census Division</a>
<ul>
<li><a href="#fetch-census-data" id="toc-fetch-census-data">Fetch Census
Data</a></li>
<li><a href="#compute-bayesian-surprise" id="toc-compute-bayesian-surprise">Compute Bayesian Surprise</a></li>
<li><a href="#visualize-surprising-regions" id="toc-visualize-surprising-regions">Visualize Surprising
Regions</a></li>
<li><a href="#identify-most-surprising-regions" id="toc-identify-most-surprising-regions">Identify Most Surprising
Regions</a></li>
</ul></li>
<li><a href="#example-2-housing-analysis-in-metro-vancouver" id="toc-example-2-housing-analysis-in-metro-vancouver">Example 2:
Housing Analysis in Metro Vancouver</a></li>
<li><a href="#example-3-language-at-home-analysis" id="toc-example-3-language-at-home-analysis">Example 3: Language at Home
Analysis</a></li>
<li><a href="#example-4-provincial-comparison-with-funnel-plot" id="toc-example-4-provincial-comparison-with-funnel-plot">Example 4:
Provincial Comparison with Funnel Plot</a></li>
<li><a href="#example-5-comparing-census-years" id="toc-example-5-comparing-census-years">Example 5: Comparing Census
Years</a></li>
<li><a href="#example-6-custom-model-space-for-census-data" id="toc-example-6-custom-model-space-for-census-data">Example 6: Custom
Model Space for Census Data</a></li>
<li><a href="#interpreting-surprise-values" id="toc-interpreting-surprise-values">Interpreting Surprise
Values</a></li>
<li><a href="#session-info" id="toc-session-info">Session Info</a></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This vignette demonstrates how to use the
<code>bayesiansurprise</code> package with Canadian Census data accessed
through the <code>cancensus</code> package. The cancensus package
provides access to Canadian Census data from 1996 through 2021 via the
CensusMapper API.</p>
<p>Canadian Census data is particularly well-suited for Bayesian
Surprise analysis because it provides:</p>
<ul>
<li>Comprehensive population data at multiple geographic levels</li>
<li>Rich demographic and socioeconomic variables</li>
<li>Consistent geography across Census years</li>
<li>Both counts and rates for many variables</li>
</ul>
<div id="paper-matching-vs.-normalized-mode" class="section level2">
<h2>Paper-Matching vs. Normalized Mode</h2>
<p>This package provides two modes for computing surprise:</p>
<ul>
<li><p><strong>Paper-matching mode</strong>
(<code>normalize_posterior = FALSE</code>): Exactly replicates the
original Correll &amp; Heer (2017) JavaScript implementation. Uses
unnormalized posteriors in the KL divergence computation. Recommended
for comparing results with the original paper.</p></li>
<li><p><strong>Normalized mode</strong>
(<code>normalize_posterior = TRUE</code>, default): Uses proper Bayesian
posterior normalization. Mathematically conventional but produces
different values than the original paper.</p></li>
</ul>
<p>For this vignette, we use paper-matching mode to ensure results are
comparable to the original methodology.</p>
</div>
<div id="prerequisites" class="section level2">
<h2>Prerequisites</h2>
<p>You’ll need a CensusMapper API key from <a href="https://censusmapper.ca/users/sign_up" class="uri">https://censusmapper.ca/users/sign_up</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(bayesiansurprise)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(cancensus)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># Set your CensusMapper API key (do this once)</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># set_cancensus_api_key(&quot;YOUR_KEY_HERE&quot;, install = TRUE)</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># Optionally set a cache path for faster subsequent queries</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co"># set_cancensus_cache_path(&quot;path/to/cache&quot;, install = TRUE)</span></span></code></pre></div>
<hr />
</div>
</div>
<div id="understanding-cancensus-data-structure" class="section level1">
<h1>Understanding cancensus Data Structure</h1>
<p>Before diving into analysis, let’s understand the available datasets
and variables.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># List available Census datasets</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">list_census_datasets</span>()</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">print</span>(datasets <span class="sc">%&gt;%</span> <span class="fu">select</span>(dataset, description))</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># List regions for the 2021 Census</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>regions_2021 <span class="ot">&lt;-</span> <span class="fu">list_census_regions</span>(<span class="st">&quot;CA21&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">head</span>(regions_2021 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="st">&quot;CMA&quot;</span>))</span></code></pre></div>
<hr />
</div>
<div id="example-1-low-income-rates-by-census-division" class="section level1">
<h1>Example 1: Low Income Rates by Census Division</h1>
<p>Let’s examine low income rates across Canada’s Census Divisions and
identify which regions have surprisingly high or low rates.</p>
<div id="fetch-census-data" class="section level2">
<h2>Fetch Census Data</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Find relevant vectors for low income</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co"># v_CA21_1085: Total - Low-income status in 2020</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># v_CA21_1086: 0 to 17 years in low income</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co"># v_CA21_1090: In low income</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co"># Get low income data at the Census Division level for all of Canada</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co"># Using labels = &quot;short&quot; for cleaner column names</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>income_data <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA21&quot;</span>,</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">C =</span> <span class="st">&quot;01&quot;</span>),  <span class="co"># All of Canada</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="at">total_pop =</span> <span class="st">&quot;v_CA21_1085&quot;</span>,  <span class="co"># Total population for low income status</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="at">low_income =</span> <span class="st">&quot;v_CA21_1090&quot;</span>   <span class="co"># Population in low income</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  ),</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;CD&quot;</span>,</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="st">&quot;sf&quot;</span>,</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co"># Clean and filter</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>income_data <span class="ot">&lt;-</span> income_data <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(total_pop) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(low_income)) <span class="sc">%&gt;%</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="fu">filter</span>(total_pop <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>    <span class="at">low_income_rate =</span> low_income <span class="sc">/</span> total_pop</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  )</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="fu">head</span>(income_data <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(GeoUID, <span class="st">`</span><span class="at">Region Name</span><span class="st">`</span>, total_pop, low_income, low_income_rate))</span></code></pre></div>
</div>
<div id="compute-bayesian-surprise" class="section level2">
<h2>Compute Bayesian Surprise</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Compute surprise using paper-matching mode</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>income_surprise <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  income_data,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">observed =</span> low_income,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="at">expected =</span> total_pop,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">&quot;uniform&quot;</span>, <span class="st">&quot;baserate&quot;</span>, <span class="st">&quot;funnel&quot;</span>),</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="fu">print</span>(income_surprise)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="fu">summary</span>(income_surprise)</span></code></pre></div>
</div>
<div id="visualize-surprising-regions" class="section level2">
<h2>Visualize Surprising Regions</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Add surprise values to data</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>income_data<span class="sc">$</span>surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(income_surprise, <span class="st">&quot;surprise&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>income_data<span class="sc">$</span>signed_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(income_surprise, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co"># Transform to Statistics Canada Lambert projection for better Canada visualization</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>income_data_lambert <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(income_data, <span class="st">&quot;EPSG:3347&quot;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co"># Plot Canada-wide</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="fu">ggplot</span>(income_data_lambert) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> signed_surprise), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  <span class="fu">scale_fill_surprise_thresholds</span>() <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Surprising Low Income Rates by Census Division&quot;</span>,</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Red = Higher than expected | Blue = Lower than expected&quot;</span>,</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Source: Statistics Canada, 2021 Census&quot;</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>,</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="identify-most-surprising-regions" class="section level2">
<h2>Identify Most Surprising Regions</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Top regions with surprisingly HIGH low income</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>high_income_surprise <span class="ot">&lt;-</span> income_data <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="fu">filter</span>(signed_surprise <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(surprise)) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Region Name</span><span class="st">`</span>, low_income_rate, total_pop, surprise) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Census Divisions with SURPRISINGLY HIGH low income rates:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="fu">print</span>(high_income_surprise)</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co"># Top regions with surprisingly LOW low income</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>low_income_surprise <span class="ot">&lt;-</span> income_data <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="fu">filter</span>(signed_surprise <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(surprise)) <span class="sc">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Region Name</span><span class="st">`</span>, low_income_rate, total_pop, surprise) <span class="sc">%&gt;%</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Census Divisions with SURPRISINGLY LOW low income rates:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="fu">print</span>(low_income_surprise)</span></code></pre></div>
<hr />
</div>
</div>
<div id="example-2-housing-analysis-in-metro-vancouver" class="section level1">
<h1>Example 2: Housing Analysis in Metro Vancouver</h1>
<p>Let’s analyze owner-occupied housing rates at the Census Tract level
within the Vancouver CMA.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Get housing tenure data for Vancouver CMA</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co"># v_CA21_4237: Total private households by tenure</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># v_CA21_4238: Owner households</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>housing_data <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA21&quot;</span>,</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">CMA =</span> <span class="st">&quot;59933&quot;</span>),  <span class="co"># Vancouver CMA</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="at">total_hh =</span> <span class="st">&quot;v_CA21_4237&quot;</span>,  <span class="co"># Total households</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="at">owner_hh =</span> <span class="st">&quot;v_CA21_4238&quot;</span>   <span class="co"># Owner households</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  ),</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;CT&quot;</span>,</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="st">&quot;sf&quot;</span>,</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>housing_data <span class="ot">&lt;-</span> housing_data <span class="sc">%&gt;%</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(total_hh) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(owner_hh)) <span class="sc">%&gt;%</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>  <span class="fu">filter</span>(total_hh <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span>  <span class="co"># Filter small tracts</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>    <span class="at">owner_rate =</span> owner_hh <span class="sc">/</span> total_hh</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>  )</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of Census Tracts:&quot;</span>, <span class="fu">nrow</span>(housing_data), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Compute surprise - use uniform and baserate only for local CMA analysis</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># (funnel model absorbs too much variation at this scale)</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>housing_surprise <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  housing_data,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="at">observed =</span> owner_hh,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="at">expected =</span> total_hh,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">&quot;uniform&quot;</span>, <span class="st">&quot;baserate&quot;</span>),</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>housing_data<span class="sc">$</span>signed_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(housing_surprise, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co"># Plot Vancouver</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="fu">ggplot</span>(housing_data) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> signed_surprise), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="fu">scale_fill_surprise_thresholds</span>() <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Surprising Home Ownership Rates in Metro Vancouver&quot;</span>,</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Census Tract Level | Red = More owners | Blue = Fewer owners than expected&quot;</span>,</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Source: Statistics Canada, 2021 Census&quot;</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>,</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  )</span></code></pre></div>
<hr />
</div>
<div id="example-3-language-at-home-analysis" class="section level1">
<h1>Example 3: Language at Home Analysis</h1>
<p>Identify areas with surprising concentrations of non-official
language speakers.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Get language data for Toronto CMA</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co"># v_CA21_1144: Total - Knowledge of official languages</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># v_CA21_1153: Neither English nor French</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>language_data <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA21&quot;</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">CMA =</span> <span class="st">&quot;35535&quot;</span>),  <span class="co"># Toronto CMA</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="at">total_pop =</span> <span class="st">&quot;v_CA21_1144&quot;</span>,  <span class="co"># Total population</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="at">no_official =</span> <span class="st">&quot;v_CA21_1153&quot;</span>   <span class="co"># Neither official language</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  ),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;CT&quot;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="st">&quot;sf&quot;</span>,</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>language_data <span class="ot">&lt;-</span> language_data <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(total_pop) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(no_official)) <span class="sc">%&gt;%</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  <span class="fu">filter</span>(total_pop <span class="sc">&gt;</span> <span class="dv">100</span>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Compute surprise - use uniform and baserate only for local CMA analysis</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>lang_surprise <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  language_data,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="at">observed =</span> no_official,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="at">expected =</span> total_pop,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">&quot;uniform&quot;</span>, <span class="st">&quot;baserate&quot;</span>),</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>language_data<span class="sc">$</span>signed_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(lang_surprise, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co"># Plot Toronto</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="fu">ggplot</span>(language_data) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> signed_surprise), <span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">scale_fill_surprise_thresholds</span>() <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Surprising Non-Official Language Concentrations in Toronto&quot;</span>,</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Census Tract Level | Red = Higher | Blue = Lower concentration than expected&quot;</span>,</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Source: Statistics Canada, 2021 Census&quot;</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>,</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>  )</span></code></pre></div>
<hr />
</div>
<div id="example-4-provincial-comparison-with-funnel-plot" class="section level1">
<h1>Example 4: Provincial Comparison with Funnel Plot</h1>
<p>Compare provinces using a funnel plot to account for population size
variation.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Get provincial data</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>provincial_data <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA21&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">C =</span> <span class="st">&quot;01&quot;</span>),</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="at">total_pop =</span> <span class="st">&quot;v_CA21_1085&quot;</span>,  <span class="co"># Total for low income</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="at">low_income =</span> <span class="st">&quot;v_CA21_1090&quot;</span>   <span class="co"># In low income</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  ),</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;PR&quot;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="cn">NA</span>,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>)</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>provincial_data <span class="ot">&lt;-</span> provincial_data <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(total_pop) <span class="sc">&amp;</span> total_pop <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co"># Compute funnel data for points</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>funnel_df <span class="ot">&lt;-</span> <span class="fu">compute_funnel_data</span>(</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  <span class="at">observed =</span> provincial_data<span class="sc">$</span>low_income,</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>  <span class="at">sample_size =</span> provincial_data<span class="sc">$</span>total_pop,</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;count&quot;</span>,</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>)</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>funnel_df<span class="sc">$</span>province <span class="ot">&lt;-</span> provincial_data<span class="sc">$</span><span class="st">`</span><span class="at">Region Name</span><span class="st">`</span></span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>funnel_df<span class="sc">$</span>rate <span class="ot">&lt;-</span> funnel_df<span class="sc">$</span>observed <span class="sc">/</span> funnel_df<span class="sc">$</span>sample_size</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a><span class="co"># National rate</span></span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>national_rate <span class="ot">&lt;-</span> <span class="fu">sum</span>(provincial_data<span class="sc">$</span>low_income) <span class="sc">/</span> <span class="fu">sum</span>(provincial_data<span class="sc">$</span>total_pop)</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a><span class="co"># Create continuous funnel bands</span></span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>n_range <span class="ot">&lt;-</span> <span class="fu">range</span>(provincial_data<span class="sc">$</span>total_pop)</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>n_seq <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="fu">log</span>(n_range[<span class="dv">1</span>] <span class="sc">*</span> <span class="fl">0.8</span>), <span class="fu">log</span>(n_range[<span class="dv">2</span>] <span class="sc">*</span> <span class="fl">1.2</span>), <span class="at">length.out =</span> <span class="dv">200</span>))</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>se_seq <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(national_rate <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> national_rate) <span class="sc">/</span> n_seq)</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>funnel_bands <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>  <span class="at">n =</span> n_seq,</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>  <span class="at">rate =</span> national_rate,</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>  <span class="at">lower_2sd =</span> national_rate <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> se_seq,</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>  <span class="at">upper_2sd =</span> national_rate <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> se_seq,</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>  <span class="at">lower_3sd =</span> national_rate <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> se_seq,</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>  <span class="at">upper_3sd =</span> national_rate <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> se_seq</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>)</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a><span class="co"># Create funnel plot</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>  <span class="co"># 3 SD band (outer)</span></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>    <span class="at">data =</span> funnel_bands,</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">ymin =</span> lower_3sd, <span class="at">ymax =</span> upper_3sd),</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;#9ecae1&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>  <span class="co"># 2 SD band (inner)</span></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>    <span class="at">data =</span> funnel_bands,</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">ymin =</span> lower_2sd, <span class="at">ymax =</span> upper_2sd),</span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;#3182bd&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>  <span class="co"># National average line</span></span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>    <span class="at">yintercept =</span> national_rate,</span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;#636363&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>  <span class="co"># Points</span></span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a>    <span class="at">data =</span> funnel_df,</span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> sample_size, <span class="at">y =</span> rate, <span class="at">color =</span> <span class="fu">abs</span>(z_score) <span class="sc">&gt;</span> <span class="dv">2</span>),</span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a>  <span class="co"># Labels</span></span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb12-72"><a href="#cb12-72" tabindex="-1"></a>    <span class="at">data =</span> funnel_df,</span>
<span id="cb12-73"><a href="#cb12-73" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> sample_size, <span class="at">y =</span> rate, <span class="at">label =</span> province),</span>
<span id="cb12-74"><a href="#cb12-74" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>,</span>
<span id="cb12-75"><a href="#cb12-75" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="dv">15</span>,</span>
<span id="cb12-76"><a href="#cb12-76" tabindex="-1"></a>    <span class="at">segment.color =</span> <span class="st">&quot;gray60&quot;</span></span>
<span id="cb12-77"><a href="#cb12-77" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-78"><a href="#cb12-78" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb12-79"><a href="#cb12-79" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;FALSE&quot;</span> <span class="ot">=</span> <span class="st">&quot;#636363&quot;</span>, <span class="st">&quot;TRUE&quot;</span> <span class="ot">=</span> <span class="st">&quot;#e6550d&quot;</span>),</span>
<span id="cb12-80"><a href="#cb12-80" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb12-81"><a href="#cb12-81" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-82"><a href="#cb12-82" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(</span>
<span id="cb12-83"><a href="#cb12-83" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>comma,</span>
<span id="cb12-84"><a href="#cb12-84" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">1e4</span>, <span class="fl">1e5</span>, <span class="fl">1e6</span>, <span class="fl">1e7</span>)</span>
<span id="cb12-85"><a href="#cb12-85" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-86"><a href="#cb12-86" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb12-87"><a href="#cb12-87" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-88"><a href="#cb12-88" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Funnel Plot: Provincial Low Income Rates&quot;</span>,</span>
<span id="cb12-89"><a href="#cb12-89" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Provinces outside bands have surprising rates given population size&quot;</span>,</span>
<span id="cb12-90"><a href="#cb12-90" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Population (log scale)&quot;</span>,</span>
<span id="cb12-91"><a href="#cb12-91" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Low Income Rate&quot;</span>,</span>
<span id="cb12-92"><a href="#cb12-92" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Source: Statistics Canada, 2021 Census&quot;</span></span>
<span id="cb12-93"><a href="#cb12-93" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-94"><a href="#cb12-94" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-95"><a href="#cb12-95" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-96"><a href="#cb12-96" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),</span>
<span id="cb12-97"><a href="#cb12-97" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb12-98"><a href="#cb12-98" tabindex="-1"></a>  )</span></code></pre></div>
<hr />
</div>
<div id="example-5-comparing-census-years" class="section level1">
<h1>Example 5: Comparing Census Years</h1>
<p>Compare surprise patterns between 2016 and 2021 Census at the
provincial level.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Get provincial data for 2016 and 2021</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co"># Note: Variable IDs differ between Census years</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># 2021 data</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>prov_2021 <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA21&quot;</span>,</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">C =</span> <span class="st">&quot;01&quot;</span>),</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(<span class="at">total_pop =</span> <span class="st">&quot;v_CA21_1085&quot;</span>, <span class="at">low_income =</span> <span class="st">&quot;v_CA21_1090&quot;</span>),</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;PR&quot;</span>,</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="cn">NA</span>,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>prov_2021 <span class="ot">&lt;-</span> prov_2021[<span class="sc">!</span><span class="fu">is.na</span>(prov_2021<span class="sc">$</span>total_pop) <span class="sc">&amp;</span> prov_2021<span class="sc">$</span>total_pop <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>prov_2021<span class="sc">$</span>census_year <span class="ot">&lt;-</span> <span class="dv">2021</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co"># 2016 data (different vector IDs for same concept)</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>prov_2016 <span class="ot">&lt;-</span> <span class="fu">get_census</span>(</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">&quot;CA16&quot;</span>,</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  <span class="at">regions =</span> <span class="fu">list</span>(<span class="at">C =</span> <span class="st">&quot;01&quot;</span>),</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="at">vectors =</span> <span class="fu">c</span>(<span class="at">total_pop =</span> <span class="st">&quot;v_CA16_2540&quot;</span>, <span class="at">low_income =</span> <span class="st">&quot;v_CA16_2555&quot;</span>),</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  <span class="at">level =</span> <span class="st">&quot;PR&quot;</span>,</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  <span class="at">geo_format =</span> <span class="cn">NA</span>,</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>  <span class="at">labels =</span> <span class="st">&quot;short&quot;</span>,</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>)</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>prov_2016 <span class="ot">&lt;-</span> prov_2016[<span class="sc">!</span><span class="fu">is.na</span>(prov_2016<span class="sc">$</span>total_pop) <span class="sc">&amp;</span> prov_2016<span class="sc">$</span>total_pop <span class="sc">&gt;</span> <span class="dv">0</span>, ]</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>prov_2016<span class="sc">$</span>census_year <span class="ot">&lt;-</span> <span class="dv">2016</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a><span class="co"># Compute surprise for each year using paper-matching mode</span></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>surprise_2021 <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>  prov_2021,</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>  <span class="at">observed =</span> low_income,</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a>  <span class="at">expected =</span> total_pop,</span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">&quot;uniform&quot;</span>, <span class="st">&quot;baserate&quot;</span>, <span class="st">&quot;funnel&quot;</span>),</span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>)</span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>prov_2021<span class="sc">$</span>signed_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(surprise_2021, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>surprise_2016 <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>  prov_2016,</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>  <span class="at">observed =</span> low_income,</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>  <span class="at">expected =</span> total_pop,</span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">c</span>(<span class="st">&quot;uniform&quot;</span>, <span class="st">&quot;baserate&quot;</span>, <span class="st">&quot;funnel&quot;</span>),</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>)</span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>prov_2016<span class="sc">$</span>signed_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(surprise_2016, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a><span class="co"># Compare changes</span></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>  prov_2016[, <span class="fu">c</span>(<span class="st">&quot;GeoUID&quot;</span>, <span class="st">&quot;Region Name&quot;</span>, <span class="st">&quot;signed_surprise&quot;</span>)],</span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>  prov_2021[, <span class="fu">c</span>(<span class="st">&quot;GeoUID&quot;</span>, <span class="st">&quot;signed_surprise&quot;</span>)],</span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">&quot;GeoUID&quot;</span>,</span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>  <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">&quot;_2016&quot;</span>, <span class="st">&quot;_2021&quot;</span>)</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>)</span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>comparison<span class="sc">$</span>change <span class="ot">&lt;-</span> comparison<span class="sc">$</span>signed_surprise_2021 <span class="sc">-</span> comparison<span class="sc">$</span>signed_surprise_2016</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a><span class="fu">print</span>(comparison[<span class="fu">order</span>(<span class="fu">abs</span>(comparison<span class="sc">$</span>change), <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ])</span></code></pre></div>
<p>Note: This example is not evaluated because it requires multiple API
calls. Run locally with your CensusMapper API key.</p>
<hr />
</div>
<div id="example-6-custom-model-space-for-census-data" class="section level1">
<h1>Example 6: Custom Model Space for Census Data</h1>
<p>For Census data with known population distributions, create a custom
model space.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Using the Vancouver housing data</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co"># Create a custom model space</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co"># Create custom model space with uniform and baserate models</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co"># (funnel is better suited for cross-regional comparisons, not local CMA analysis)</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>housing_models <span class="ot">&lt;-</span> <span class="fu">model_space</span>(</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="fu">bs_model_uniform</span>(),</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="fu">bs_model_baserate</span>(housing_data<span class="sc">$</span>total_hh)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="fu">print</span>(housing_models)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="co"># Use surprise() with custom model space</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>custom_result <span class="ot">&lt;-</span> <span class="fu">surprise</span>(</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  housing_data,</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="at">observed =</span> owner_hh,</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  <span class="at">expected =</span> total_hh,</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="at">models =</span> housing_models,</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  <span class="at">normalize_posterior =</span> <span class="cn">FALSE</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>)</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>housing_data<span class="sc">$</span>custom_surprise <span class="ot">&lt;-</span> <span class="fu">get_surprise</span>(custom_result, <span class="st">&quot;signed&quot;</span>)</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Custom model surprise summary:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a><span class="fu">summary</span>(housing_data<span class="sc">$</span>custom_surprise)</span></code></pre></div>
<hr />
</div>
<div id="interpreting-surprise-values" class="section level1">
<h1>Interpreting Surprise Values</h1>
<p>Understanding what surprise values mean is crucial for proper
interpretation:</p>
<table>
<colgroup>
<col width="43%" />
<col width="36%" />
<col width="20%" />
</colgroup>
<thead>
<tr class="header">
<th>Surprise Magnitude</th>
<th>Interpretation</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>&lt; 0.1</td>
<td>Trivial</td>
<td>Essentially as expected; data doesn’t discriminate between
models</td>
</tr>
<tr class="even">
<td>0.1 - 0.3</td>
<td>Minor</td>
<td>Small deviation; worth noting but not remarkable</td>
</tr>
<tr class="odd">
<td>0.3 - 0.5</td>
<td>Moderate</td>
<td>Meaningful deviation that warrants attention</td>
</tr>
<tr class="even">
<td>0.5 - 1.0</td>
<td>Substantial</td>
<td>Genuinely surprising; strong evidence for deviation</td>
</tr>
<tr class="odd">
<td>&gt; 1.0</td>
<td>High</td>
<td>Very surprising; the data strongly contradicts expectations</td>
</tr>
</tbody>
</table>
<p><strong>Key insight</strong>: Surprise measures how much the data
discriminates between models, not just how far a rate is from average. A
region with an unusual rate but average population may show low surprise
because all models predict similar things for it. Conversely, a large
region with a rate close to average may show high surprise if it
strongly confirms or refutes the funnel model’s predictions about
sampling variation.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Categorize regions by surprise level</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>income_data <span class="ot">&lt;-</span> income_data <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="at">surprise_category =</span> <span class="fu">cut</span>(</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="fu">abs</span>(signed_surprise),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="cn">Inf</span>),</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Trivial&quot;</span>, <span class="st">&quot;Minor&quot;</span>, <span class="st">&quot;Moderate&quot;</span>, <span class="st">&quot;Substantial&quot;</span>, <span class="st">&quot;High&quot;</span>),</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="at">include.lowest =</span> <span class="cn">TRUE</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    )</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>  )</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co"># Summary by category</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Census Divisions by surprise level:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(income_data<span class="sc">$</span>surprise_category))</span></code></pre></div>
<hr />
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#&gt; R version 4.5.0 (2025-04-11)</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt; Platform: aarch64-apple-darwin20</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#&gt; Running under: macOS Sequoia 15.4.1</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="co">#&gt; time zone: America/Vancouver</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="co">#&gt; tzcode source: internal</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a><span class="co">#&gt; [1] dplyr_1.1.4            ggplot2_4.0.1          sf_1.0-23             </span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="co">#&gt; [4] cancensus_0.5.7        bayesiansurprise_0.1.0</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a><span class="co">#&gt;  [1] gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.0     Rcpp_1.1.0        </span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a><span class="co">#&gt;  [5] tidyselect_1.2.1   jquerylib_0.1.4    scales_1.4.0       yaml_2.3.10       </span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a><span class="co">#&gt;  [9] fastmap_1.2.0      R6_2.6.1           generics_0.1.4     classInt_0.4-11   </span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a><span class="co">#&gt; [13] knitr_1.50         MASS_7.3-65        tibble_3.3.0       units_1.0-0       </span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a><span class="co">#&gt; [17] DBI_1.2.3          bslib_0.9.0        pillar_1.11.1      RColorBrewer_1.1-3</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="co">#&gt; [21] rlang_1.1.6        cachem_1.1.0       xfun_0.52          sass_0.4.10       </span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="co">#&gt; [25] S7_0.2.1           cli_3.6.5          withr_3.0.2        magrittr_2.0.4    </span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">#&gt; [29] class_7.3-23       digest_0.6.37      grid_4.5.0         lifecycle_1.0.4   </span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a><span class="co">#&gt; [33] vctrs_0.6.5        KernSmooth_2.23-26 proxy_0.4-28       evaluate_1.0.4    </span></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a><span class="co">#&gt; [37] glue_1.8.0         farver_2.1.2       e1071_1.7-17       rmarkdown_2.29    </span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a><span class="co">#&gt; [41] tools_4.5.0        pkgconfig_2.0.3    htmltools_0.5.8.1</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
